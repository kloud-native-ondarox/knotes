<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Personal Collection of Random Notes."><meta name=author content="Jesse Gonzalez"><link href=https://knotes.kloud-native.ondarox.dev/troubleshooting/kubernetes/kubernetes/ rel=canonical><link rel=icon href=../../../images/favicon.png><meta name=generator content="mkdocs-1.3.0, mkdocs-material-8.3.6"><title>kubernetes - Serving Random Kloud Native Stuff OnDaRox</title><link rel=stylesheet href=../../../assets/stylesheets/main.4a0965b7.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.cbb835fc.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#general-kubernetes-troubleshooting class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=https://knotes.kloud-native.ondarox.dev/ title="Serving Random Kloud Native Stuff OnDaRox" class="md-header__button md-logo" aria-label="Serving Random Kloud Native Stuff OnDaRox" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M479.1 32H32.04C12.55 32-2.324 49.25.3 68.51L56.29 425.1c4.5 31.5 31.49 54.9 63.51 54.9h272.9c31.74 0 58.86-23.38 63.36-54.89l55.61-356.6C514.3 49.25 499.5 32 479.1 32zm-56.4 192H89.49L69.39 96h373.2L422.7 224z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Serving Random Kloud Native Stuff OnDaRox </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> kubernetes </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=red data-md-color-accent=red aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/kloud-native-ondarox/knotes title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kloud-native-ondarox/knotes </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../.. class=md-tabs__link> home </a> </li> <li class=md-tabs__item> <a href=../../../architecture-tldr/kubernetes-best-practices/references/ class=md-tabs__link> architecture tldr </a> </li> <li class=md-tabs__item> <a href=./ class="md-tabs__link md-tabs__link--active"> troubleshooting stuff </a> </li> <li class=md-tabs__item> <a href=../../../walkthroughs/nutanix/karbon/airgap/ class=md-tabs__link> random walkthroughs </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://knotes.kloud-native.ondarox.dev/ title="Serving Random Kloud Native Stuff OnDaRox" class="md-nav__button md-logo" aria-label="Serving Random Kloud Native Stuff OnDaRox" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M479.1 32H32.04C12.55 32-2.324 49.25.3 68.51L56.29 425.1c4.5 31.5 31.49 54.9 63.51 54.9h272.9c31.74 0 58.86-23.38 63.36-54.89l55.61-356.6C514.3 49.25 499.5 32 479.1 32zm-56.4 192H89.49L69.39 96h373.2L422.7 224z"/></svg> </a> Serving Random Kloud Native Stuff OnDaRox </label> <div class=md-nav__source> <a href=https://github.com/kloud-native-ondarox/knotes title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kloud-native-ondarox/knotes </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../.. class=md-nav__link> home </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> architecture tldr <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="architecture tldr" data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> architecture tldr </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../architecture-tldr/kubernetes-best-practices/references/ class=md-nav__link> kubernetes best practices </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3> troubleshooting stuff <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="troubleshooting stuff" data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> troubleshooting stuff </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_1 type=checkbox id=__nav_3_1 checked> <label class=md-nav__link for=__nav_3_1> kubernetes <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=kubernetes data-md-level=2> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> kubernetes </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> kubernetes <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> kubernetes </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#connect-to-api-server-without-kubectl-proxy class=md-nav__link> Connect to API server without KUBECTL Proxy </a> </li> <li class=md-nav__item> <a href=#accessing-the-api-from-a-pod class=md-nav__link> Accessing the API from a Pod </a> </li> <li class=md-nav__item> <a href=#querying-stuff class=md-nav__link> Querying Stuff </a> </li> <li class=md-nav__item> <a href=#labels-and-selectors class=md-nav__link> Labels and Selectors </a> </li> <li class=md-nav__item> <a href=#port-forwarding class=md-nav__link> port forwarding </a> </li> <li class=md-nav__item> <a href=#logging class=md-nav__link> logging </a> </li> <li class=md-nav__item> <a href=#events class=md-nav__link> Events </a> </li> <li class=md-nav__item> <a href=#resource-monitoring class=md-nav__link> Resource Monitoring </a> </li> <li class=md-nav__item> <a href=#events-logs class=md-nav__link> Events &amp; Logs </a> </li> <li class=md-nav__item> <a href=#using-jsonpath class=md-nav__link> Using Jsonpath </a> </li> <li class=md-nav__item> <a href=#troubleshooting-node-failures class=md-nav__link> Troubleshooting Node Failures </a> <nav class=md-nav aria-label="Troubleshooting Node Failures"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#break-node class=md-nav__link> Break Node </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#kubernetes-security class=md-nav__link> Kubernetes Security </a> </li> <li class=md-nav__item> <a href=#investigating-the-pki-setup-on-the-control-plane-node class=md-nav__link> Investigating the PKI setup on the Control Plane Node </a> </li> <li class=md-nav__item> <a href=#kubernetes-create-new-user-certificate class=md-nav__link> Kubernetes - Create New User Certificate </a> <nav class=md-nav aria-label="Kubernetes - Create New User Certificate"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-create-a-rsa-private-key class=md-nav__link> 1 - Create a RSA private key </a> </li> <li class=md-nav__item> <a href=#2-generate-a-csr class=md-nav__link> 2 - Generate a CSR </a> </li> <li class=md-nav__item> <a href=#1b2b-alternative-create-a-new-private-key-and-certificate-signing-request class=md-nav__link> 1B/2B - ALTERNATIVE - Create a new private key AND Certificate Signing Request </a> </li> <li class=md-nav__item> <a href=#3-submit-the-certificatesigningrequest-to-the-api-server-k8s-119 class=md-nav__link> 3 - Submit the CertificateSigningRequest to the API Server - K8s 1.19+ </a> </li> <li class=md-nav__item> <a href=#3-submit-the-certificatesigningrequest-to-the-api-server-k8s-118 class=md-nav__link> 3 - Submit the CertificateSigningRequest to the API Server - K8s 1.18 </a> </li> <li class=md-nav__item> <a href=#4-approve-the-csr class=md-nav__link> 4 - Approve the CSR </a> </li> <li class=md-nav__item> <a href=#5-retrieve-the-certificate-from-the-csr-object-its-base64-encoded class=md-nav__link> 5 - Retrieve the certificate from the CSR object, it's base64 encoded </a> </li> <li class=md-nav__item> <a href=#complete-alternative-a-create-a-self-signed-certificate class=md-nav__link> COMPLETE ALTERNATIVE A - Create a Self-signed Certificate </a> </li> <li class=md-nav__item> <a href=#misc-alternative-b class=md-nav__link> MISC ALTERNATIVE B </a> <nav class=md-nav aria-label="MISC ALTERNATIVE B"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#create-a-csr-from-existing-certificate-and-private-key class=md-nav__link> Create a CSR from existing certificate and private key </a> </li> <li class=md-nav__item> <a href=#generate-a-csr-for-multi-domain-san-certificate-by-supplying-an-openssl-config-file class=md-nav__link> Generate a CSR for multi-domain SAN certificate by supplying an openssl config file: </a> </li> <li class=md-nav__item> <a href=#create-x509-certificates class=md-nav__link> Create X.509 certificates </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#troubleshooting-certificate-issues class=md-nav__link> Troubleshooting Certificate Issues </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#capacity-planning class=md-nav__link> Capacity Planning </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../etcd/ class=md-nav__link> etcd </a> </li> <li class=md-nav__item> <a href=../../kubernetes-best-practices/references.md class=md-nav__link> references </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> random walkthroughs <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="random walkthroughs" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> random walkthroughs </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1 type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1> nutanix karbon <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="nutanix karbon" data-md-level=2> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> nutanix karbon </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../walkthroughs/nutanix/karbon/airgap/ class=md-nav__link> airgap deployments </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=general-kubernetes-troubleshooting>General Kubernetes Troubleshooting<a class=headerlink href=#general-kubernetes-troubleshooting title="Permanent link">&para;</a></h1> <h2 id=connect-to-api-server-without-kubectl-proxy>Connect to API server without KUBECTL Proxy<a class=headerlink href=#connect-to-api-server-without-kubectl-proxy title="Permanent link">&para;</a></h2> <p>Example Below:</p> <pre><code class=language-bash>APISERVER=$(kubectl config view --minify | grep server | cut -f 2- -d &quot;:&quot; | tr -d &quot; &quot;)
SECRET_NAME=$(kubectl get secrets | grep ^default | cut -f1 -d ' ')
TOKEN=$(kubectl describe secret $SECRET_NAME | grep -E '^token' | cut -f2 -d':' | tr -d &quot; &quot;)

curl $APISERVER/api --header &quot;Authorization: Bearer $TOKEN&quot; --insecure
</code></pre> <p>alternative way of getting cluster info:</p> <p>APISERVER=$(kubectl config view --minify -ojsonpath='{.clusters[*].cluster.server}')</p> <h2 id=accessing-the-api-from-a-pod>Accessing the API from a Pod<a class=headerlink href=#accessing-the-api-from-a-pod title="Permanent link">&para;</a></h2> <p>APISERVER=kubernetes.default.svc TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</p> <p>https://kubernetes.io/docs/tasks/access-application-cluster/port-forward-access-application-cluster/</p> <p>finding info using go-template:</p> <p><code>kubectl get pod redis-master-765d459796-258hz --template='{{(index (index .spec.containers 0).ports 0).containerPort}}{{"\n"}}'</code></p> <p>vs. same info in jsonpath:</p> <p><code>kubectl get pod redis-master-6b54579d85-vkhdd -ojsonpath='{.spec.containers[0].ports[0].containerPort}{"\n"}'</code></p> <h2 id=querying-stuff>Querying Stuff<a class=headerlink href=#querying-stuff title="Permanent link">&para;</a></h2> <p>finding info using go-template:</p> <p><code>kubectl get pod redis-master-765d459796-258hz --template='{{(index (index .spec.containers 0).ports 0).containerPort}}{{"\n"}}'</code></p> <p>vs. same info in jsonpath:</p> <p><code>kubectl get pod redis-master-6b54579d85-vkhdd -ojsonpath='{.spec.containers[0].ports[0].containerPort}{"\n"}'</code></p> <p>using custom-columns</p> <p><code>kubectl get pod multi-cont-pod -o custom-columns=CONTAINER:.spec.containers[0].name,IMAGE:.spec.containers[0].image</code></p> <p>using sort-by</p> <p><code>kubectl get pods --sort-by=.metadata.name</code> <code>kubectl get pods --sort-by=.metadata.creationTimestamp</code></p> <p>using range with new line</p> <p><code>kubectl get po -l app=try -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}'</code></p> <h2 id=labels-and-selectors>Labels and Selectors<a class=headerlink href=#labels-and-selectors title="Permanent link">&para;</a></h2> <p>overwrite label</p> <p><code>kubectl label --overwrite pods nginx2 app=v2</code></p> <p>show labels</p> <p><code>kubectl get pods --show-labels</code></p> <p>get pods based on selector (equality based)</p> <p><code>kubectl get pods --selector=app=v2</code> <code>kubectl get pods -l app=v2</code> <code>kubectl get pods -l 'env in (dev,prod)'</code></p> <p>show label columns, i.e. app</p> <p><code>kubectl get pods --label-columns=app</code> <code>kubectl get pods -L app</code> <code>kubectl get pods -L app -L tier</code></p> <p>delete labels by appending -</p> <p><code>kubectl label pods nginx1 env-</code></p> <p>set labels on nodes</p> <p><code>kubectl label nodes kubernetes-foo-node-1.c.a-robinson.internal disktype=ssd</code></p> <h2 id=port-forwarding>port forwarding<a class=headerlink href=#port-forwarding title="Permanent link">&para;</a></h2> <p><code>kubectl port-forward redis-master-765d459796-258hz 7000:6379</code></p> <h2 id=logging>logging<a class=headerlink href=#logging title="Permanent link">&para;</a></h2> <p><code>kubectl logs nginx --all-containers=true --prefix=true --since=60m --tail=20 --timestamps=true</code></p> <h2 id=events>Events<a class=headerlink href=#events title="Permanent link">&para;</a></h2> <p>To monitor events in background</p> <p><code>kubectl get events -w &amp;</code></p> <p>run <code>fg</code> and <code>ctrl-c</code> to kill process</p> <p><code>kubectl describe po busybox | grep -A 10 Events</code></p> <h2 id=resource-monitoring>Resource Monitoring<a class=headerlink href=#resource-monitoring title="Permanent link">&para;</a></h2> <p>https://kubernetes.io/docs/tasks/debug-application-cluster/resource-metrics-pipeline/</p> <p>make sure metrics server is installed first either via helm - https://github.com/helm/charts/tree/master/stable/metrics-server or deployment components yaml - https://github.com/kubernetes-sigs/metrics-server</p> <p>Show metrics of the above pod containers and puts them into the file.log and verify</p> <p>kubectl -n kube-system get cm kubeadm-config -oyaml</p> <h2 id=events-logs>Events &amp; Logs<a class=headerlink href=#events-logs title="Permanent link">&para;</a></h2> <p>It can be easier if the data is actually sorted...sort by isn't for just events, it can be used in most output <code>kubectl get events --sort-by='.metadata.creationTimestamp'</code></p> <p>Create a flawed deployment</p> <p><code>kubectl create deployment nginx --image ngins</code></p> <p>Time bounding your searches can be helpful in finding issues add --no-pager for line wrapping <code>journalctl -u kubelet.service --since today --no-pager</code></p> <p>We can retrieve the logs for the control plane pods by using kubectl logs. This info is coming from the API server over kubectl, it instructs the kubelet will read the log from the node and send it back to you over stdout</p> <p><code>kubectl logs --namespace kube-system kube-apiserver-c1-master1</code></p> <p>But, what if your control plane is down? Go to docker or to the file system. kubectl logs will send the request to the local node's kubelet to read the logs from disk. Since we're on the master/control plane node already we can use docker for that.</p> <p><code>sudo docker ps</code></p> <p>Grab the log for the api server pod, paste in the CONTAINER ID</p> <pre><code class=language-bash>sudo docker ps  | grep k8s_kube-apiserver
CONTAINER_ID=$(sudo docker ps | grep k8s_kube-apiserver | awk '{ print $1 }')
echo $CONTAINER_ID
sudo docker logs $CONTAINER_ID
</code></pre> <p>But, what if docker is not available? They're also available on the filesystem, here you'll find the current and the previous logs files for the containers. This is the same across all nodes and pods in the cluster. This also applies to user pods/containers. These are json formmatted which is the docker logging driver default</p> <pre><code class=language-bash>sudo ls /var/log/containers
sudo tail /var/log/containers/kube-apiserver-c1-master1*
</code></pre> <p>We can filter the list of events using field selector</p> <pre><code class=language-bash>kubectl get events --field-selector type=Warning
kubectl get events --field-selector type=Warning,reason=Failed
</code></pre> <p>We're working with the json output of our objects, in this case pods let's start by accessing that list of Pods, inside items. Look at the items, find the metadata and name sections in the json output</p> <p><code>kubectl get pods -l app=hello-world -o json &gt; pods.json</code></p> <p>It's a list of objects, so let's display the pod names <code>kubectl get pods -l app=hello-world -o jsonpath='{ .items[*].metadata.name }'</code></p> <p>Display all pods names, this will put the new line at the end of the set rather then on each object output to screen. Additional tips on formatting code in the examples below including adding a new line after each object</p> <p><code>kubectl get pods -l app=hello-world -o jsonpath='{ .items[*].metadata.name }{"\n"}'</code></p> <p>It's a list of objects, so let's display the first (zero'th) pod from the output</p> <p><code>kubectl get pods -l app=hello-world -o jsonpath='{ .items[0].metadata.name }{"\n"}'</code></p> <p>Get all container images in use by all pods in all namespaces</p> <p><code>kubectl get pods --all-namespaces -o jsonpath='{ .items[*].spec.containers[*].image }{"\n"}'</code></p> <p>We can access all container logs which will dump each containers in sequence</p> <p><code>kubectl logs $PODNAME --all-containers</code></p> <p>If we need to follow a log, we can do that...helpful in debugging real time issues. This works for both single and multi-container pods</p> <p><code>kubectl logs $PODNAME --all-containers --follow</code></p> <p>ctrl+c</p> <p>Get key information and status about the kubelet, ensure that it's active/running and check out the log. Also key information about it's configuration is available.</p> <p><code>systemctl status kubelet.service</code></p> <p>If we want to examine it's log further, we use journalctl to access it's log from journald -u for which systemd unit. If using a pager, use f and b to for forward and back.</p> <p><code>journalctl -u kubelet.service</code></p> <p>journalctl has search capabilities, but grep is likely easier</p> <p><code>journalctl -u kubelet.service | grep -i ERROR</code></p> <p>Time bounding your searches can be helpful in finding issues add --no-pager for line wrapping</p> <p><code>journalctl -u kubelet.service --since today --no-pager</code></p> <p>Get a listing of the control plane pods using a selector</p> <p><code>kubectl get pods --namespace kube-system --selector tier=control-plane</code></p> <h2 id=using-jsonpath>Using Jsonpath<a class=headerlink href=#using-jsonpath title="Permanent link">&para;</a></h2> <p>This allows us to explore the json data interactively and keep our final jq query on the clipboard</p> <p><code>kubectl get no -o json | jid -q | pbcopy</code></p> <p>Filtering a specific value in a list Let's say there's an list inside items and you need to access an element in that list... ?() - defines a filter @ - the current object</p> <p><code>kubectl get nodes -o jsonpath="{.items[*].status.addresses''[?(@.type=='InternalIP')].address}"</code></p> <p>Get all container images in use by all pods in all namespaces</p> <p><code>kubectl get pods --all-namespaces -o jsonpath='{ .items[*].spec.containers[*].image }{"\n"}'</code></p> <p>Now that we're sorting that output, maybe we want a listing of all pods sorted by a field that's part of the object but not part of the default kubectl output. like creationTimestamp and we want to see what that value is We can use a custom colume to output object field data, in this case the creation timestamp</p> <pre><code class=language-bash>kubectl get pods -A -o jsonpath='{ .items[*].metadata.name }{&quot;\n&quot;}' \
    --sort-by=.metadata.creationTimestamp \
    --output=custom-columns='NAME:metadata.name,CREATIONTIMESTAMP:metadata.creationTimestamp'

kubectl get po -A -o custom-columns=CREATE:.metadata.creationTimestamp,POD:.metadata.name,CONTAINER:.spec.containers[0].name,IMAGE:.spec.containers[0].image,PODIP:.status.podIP,HOSTIP:.status.hostIP,NS:.metadata.namespace
</code></pre> <p>One method to iterate through list</p> <pre><code class=language-bash>$ kubectl get pods --all-namespaces -o jsonpath='{ .items[*].spec.containers[*].image }{&quot;\n&quot;}' | tr &quot; &quot; &quot;\n&quot;
httpd:2.4-alpine
httpd:2.4-alpine
nginx:1.17.6-alpine
nginx:1.17.6-alpine
docker.io/calico/kube-controllers:v3.17.0
docker.io/calico/node:v3.17.0
quay.io/coreos/flannel:v0.12.0
docker.io/calico/node:v3.17.0
quay.io/coreos/flannel:v0.12.0
docker.io/calico/node:v3.17.0
quay.io/coreos/flannel:v0.12.0
k8s.gcr.io/coredns:1.7.0
k8s.gcr.io/coredns:1.7.0
k8s.gcr.io/etcd:3.4.13-0
k8s.gcr.io/kube-apiserver:v1.19.4
k8s.gcr.io/kube-controller-manager:v1.19.4
quay.io/coreos/flannel:v0.13.1-rc1
</code></pre> <p>All container images across all pods in all namespaces. Range iterates over a list performing the formatting operations on each element in the list. We can also add in a sort on the container image name</p> <p><code>kubectl get pods -A -o jsonpath='{range .items[*]}{.metadata.name}{"\t"}{.spec.containers[*].image}{"\n"}{end}' \ --sort-by=.spec.containers[*].image</code></p> <p>We can use range again to clean up the output if we want</p> <pre><code class=language-bash>kubectl get nodes -o jsonpath='{range .items[*]}{.status.addresses[?(@.type==&quot;InternalIP&quot;)].address}{&quot;\n&quot;}{end}'
kubectl get nodes -o jsonpath='{range .items[*]}{.status.addresses[?(@.type==&quot;Hostname&quot;)].address}{&quot;\n&quot;}{end}'
</code></pre> <p>We used --sortby when looking at Events earlier, let's use it for another something else now... Let's take our container image output from above and sort it</p> <pre><code class=language-bash>kubectl get pods -A -o jsonpath='{ .items[*].spec.containers[*].image }' --sort-by=.spec.containers[*].image
kubectl get pods -A -o jsonpath='{range .items[*]}{.metadata.name }{&quot;\t&quot;}{.spec.containers[*].image }{&quot;\n&quot;}{end}' --sort-by=.spec.containers[*].image
</code></pre> <p>Adding in a spaces or tabs in the output to make it a bit more readable</p> <pre><code class=language-bash>$ kubectl get pods -o jsonpath='{range .items[*]}{.metadata.name}{&quot; &quot;}{.spec.containers[*].image}{&quot;\n&quot;}{end}'
web-test-2-594487698d-jphg4 httpd:2.4-alpine
web-test-6c77dcfbc-bqp4b httpd:2.4-alpine
web-test-6c77dcfbc-vbnk7 httpd:2.4-alpine
web-test-6c77dcfbc-wh4x4 httpd:2.4-alpine
</code></pre> <pre><code class=language-bash>kubectl get pods -l app=hello-world -o jsonpath='{range .items[*]}{.metadata.name}{&quot;\t&quot;}{.spec.containers[*].image}{&quot;\n&quot;}{end}'
</code></pre> <pre><code class=language-bash>$ kubectl get pod -o jsonpath=&quot;{range .items[*]}{.metadata.name}{'\n'}{end}&quot;
web-test-2-594487698d-jphg4
web-test-6c77dcfbc-bqp4b
web-test-6c77dcfbc-vbnk7
web-test-6c77dcfbc-wh4x4
</code></pre> <h2 id=troubleshooting-node-failures>Troubleshooting Node Failures<a class=headerlink href=#troubleshooting-node-failures title="Permanent link">&para;</a></h2> <h3 id=break-node>Break Node<a class=headerlink href=#break-node title="Permanent link">&para;</a></h3> <p>To use this file to break stuff on your nodes, set the username variable to your username. This account will need sudo rights on the nodes to break things. You'll need to enter your sudo password for this account on each node for each execution. Execute the commands here one line at a time rather than running the whole script at ones. You can set up passwordless sudo to make this easier otherwise</p> <p>USER=$1</p> <blockquote> <p>Worker Node - stopped kubelet</p> </blockquote> <p>`ssh $USER@c1-node1 -t 'sudo systemctl stop kubelet.service'</p> <p>`ssh $USER@c1-node1 -t 'sudo systemctl disable kubelet.service'</p> <blockquote> <p>Worker Node - inaccessible config.yaml</p> </blockquote> <p>`ssh $USER@c1-node2 -t 'sudo mv /var/lib/kubelet/config.yaml /var/lib/kubelet/config.yml'</p> <p>`ssh $USER@c1-node2 -t 'sudo systemctl restart kubelet.service'</p> <blockquote> <p>Worker Node - misconfigured systemd unit</p> </blockquote> <p>`ssh $USER@c1-node3 -t 'sudo sed -i ''s/config.yaml/config.yml/'' /etc/systemd/system/kubelet.service.d/10-kubeadm.conf'</p> <p>`ssh $USER@c1-node3 -t 'sudo systemctl daemon-reload'</p> <p>`ssh $USER@c1-node3 -t 'sudo systemctl restart kubelet.service'</p> <p>The kubelet runs as a systemd service/unit...so we can use those tools to troubleshoot why it's not working Let's start by checking the status. Add no-pager so it will wrap the text - It's loaded, but it's inactive (dead)...so that means it's not running. We want the service to be active (running) So the first thing to check is the service enabled?</p> <p><code>sudo systemctl status kubelet.service</code></p> <p>If the service wasn't configured to start up by default (disabled) we can use enable to set it to.</p> <p><code>sudo systemctl enable kubelet.service</code></p> <p>That just enables the service to start up on boot, we could reboot now or we can start it manually So let's start it up and see what happens...ah, it's now actice (running) which means the kubelet is online. We also see in the journald snippet, that it's watching the apiserver. So good stuff there...</p> <pre><code class=language-Bash>sudo systemctl start kubelet.service
sudo systemctl status kubelet.service
</code></pre> <p>Crashlooping kubelet...indicated by the code = exited and the status = 255 But that didn't tell us WHY the kubelet is crashlooping, just that it is...let's dig deeper</p> <p><code>sudo systemctl status kubelet.service --no-pager</code></p> <p>systemd based systems write logs to journald, let's ask it for the logs for the kubelet This tells us exactly what's wrong, the failed to load the Kubelet config file which it thinks is at /var/lib/kubelet/config.yaml</p> <p><code>sudo journalctl -u kubelet.service --no-pager</code></p> <h2 id=kubernetes-security>Kubernetes Security<a class=headerlink href=#kubernetes-security title="Permanent link">&para;</a></h2> <p>Get Client Certificate Data from Kubectl Config</p> <p><code>kubectl config view --raw -o jsonpath="{.users[?(@.name=='k8s-admin')].user.client-certificate-data}" | base64 -d</code></p> <p>Get Client Key from Kubectl Config</p> <pre><code class=language-bash>$ kubectl config view --raw -o jsonpath=&quot;{.users[?(@.name=='k8s-admin')].user.client-key-data}&quot; | base64 -d
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAqEs3hslI/1ndwsN8YG1GSP8DoBFfIJXjJW0+cGelYp6hs9lm
gUmnsq9P0n26LNJpZI6SZ+lVTzgejisqF7mxXnf1kKTeRpoggo/nZ3WrLTpCjCuM
JPUfFgKo178zmVfAILWipe3Ny/JuZF17oaiAIMmVK9OZMek2dvFSlSlVB2WVOp5P
kVHFvJgQ5qYbsRW7F/l9x1dyQbVURCdRdTBMcyrOeU8lTPtH7Baceg2raxUJBbk8
SI4UJJlSPKKRkO6zmJ23PzLTFp3Cptrm17sUgw+aQ2UDUpnB7yIu4THlG3zh67W7
eTDteExV3TAjxNUbNKHPUzp2PB3wf53b2x0ONwIDAQABAoIBAATR6qw0lZ+inkRW
vvgwCQRMMXljJftT76aBw3kKruTtMCprfpETX/cxKDMaILvp5tTXdH//Yc8cB1wB
BnqZeef/vYu//RG+llHG91SyPQ3VjlRfZuskDhjeSKGtOzgYGEuXiCoCbpN5xQmg
18qgfdLykxAnRkr0p/euH7Rf86x7g2bktfmguZzdfBvISb8kIhk9o3uWc+1dTzw5
Y0nw5PzquGp0EWiTZsk9heK6gr/C0epq//g51aBpIoRGk3y7soUlF4Nkmnc9Nlqa
d5Op3cL7ObdFSbgoNyY6JO8GNhqhLjVZ06LPQx968rC+AiudTCwrb8TizBp619tD
SwgpSTECgYEAwDSmlh8mBVo2qR7A9XhfgvWdaCdAZZbi67bdktEETC77Xu6ukMj9
lhoHQz6oaJiB4O10fhiJDxK7zfks20WEjDnnaG7pEDsjb4ts5oGJ/tifCWUHZkZm
ODEhDFJLwu6Bg70Bi7xhKeKs0so39s//1zemFzRAzcxQZCG6WkDsDckCgYEA4CbS
Xz9W0TdExHz2zr0GPwn7bFZQIDIWHILWbU8tX+Zj5k/HMl1rTRQqePngFNKiNBCB
hN+2wNepBGl/1k21RNnsXTRhgwyfEYecE2nFaqf8iobwxv6SSSuexwTay7o9rKtb
iUHwpIXtxn3wRuvnbyjRLLBJlSsSGwOUXHFeO/8CgYB6ADGJcqYQma2+dZ3ncgu2
Na8/UELo+Ph6xC0qpu/CZ8P5AyndDycfos/fWCNPmRY/rpnV/D7rSWnaGQLm/95d
n9eKC3R2cANTJz3tpmXwVJHGRdGHksIJgu3GQ2qBhiDBfTRA/UbzbkVi2ybgzDBJ
7LHJYsqLltekZ2BBL5pmOQKBgQCwH/D25EbsN1gyZ9pqEX6h8875jkyBL7nOB0RD
OY52pwniAteLDHpuYyUIT5ax5duLu1h5tmrb1di5XcgT9JU1F2KwzaK9HSKz3HFX
-k6mKJ5q4olT4lzkMg1jMGlVs9NbXIQHYtNZH//AYIga1Q1FjN5g8W/xFWEVusn5V
sMKRswKBgEWWQ9peybZIaT4n9cGDoZBdp3cde6wYYae3n9zq2J9zUGuuCOlWlMHf
6ZekMDyUUS5OXhwmcMV5P8iJUq83rtGQfDhgTuECK1qMQYw+2eTgrZd3t+vk4X8c
eMKcsY2p2nlSO3P7wdZfzGSDzWYl/mDFB3UfkNdT/mKWGv7xGftx
-----END RSA PRIVATE KEY-----
</code></pre> <p>Read Certificate and Output in human readable format</p> <p><code>openssl x509 -in admin.crt -text -noout | head</code></p> <p>Accessing the API Server inside a Pod</p> <pre><code class=language-bash>PODNAME=$(kubectl get pods -l app=nginx -o jsonpath='{ .items[*].metadata.name }')
kubectl exec $PODNAME -it -- /bin/bash
ls /var/run/secrets/kubernetes.io/serviceaccount/
cat /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
cat /var/run/secrets/kubernetes.io/serviceaccount/namespace
cat /var/run/secrets/kubernetes.io/serviceaccount/token
</code></pre> <p>Load the token and cacert into variables for reuse <code>TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)</code> <code>CACERT=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</code></p> <p>But it doesn't have any permissions to access objects...this user is not authorized to access pods</p> <p>`curl --cacert $CACERT --header "Authorization: Bearer $TOKEN" -X GET https://kubernetes.default.svc/api/v1/namespaces/</p> <p>We can also use impersonation to help with our authorization testing <code>kubectl auth can-i list pods --as=system:serviceaccount:default:mysvcaccount1</code> <code>kubectl get pods -v 6 --as=system:serviceaccount:default:mysvcaccount1</code></p> <p>But we can create an RBAC Role and bind that to our service account We define who, can perform what verbs on what resources</p> <p><code>kubectl create role demorole --verb=get,list --resource=pods</code> <code>kubectl create rolebinding demorolebinding --role=demorole --serviceaccount=default:mysvcaccount1</code></p> <p>Then the service account can access the API with the https://kubernetes.io/docs/reference/access-authn-authz/rbac/#service-account-permissions</p> <p><code>kubectl auth can-i list pods --as=system:serviceaccount:default:mysvcaccount1</code> <code>kubectl get pods -v 6 --as=system:serviceaccount:default:mysvcaccount1</code></p> <p>Go back inside the pod again...</p> <pre><code class=language-bash>kubectl get pods
PODNAME=$(kubectl get pods -l app=nginx -o jsonpath='{ .items[*].metadata.name }')
kubectl exec $PODNAME -it -- /bin/bash
</code></pre> <p>Load the token and cacert into variables for reuse</p> <p><code>CACERT=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</code></p> <p>Now I can view objects...this isn't just for curl but for any application. Apps commonly use libraries to programmaticly interact with the api server for cluster state information</p> <p><code>curl --cacert $CACERT --header "Authorization: Bearer $TOKEN" -X GET https://kubernetes.default.svc/api/v1/namespaces/</code></p> <h2 id=investigating-the-pki-setup-on-the-control-plane-node>Investigating the PKI setup on the Control Plane Node<a class=headerlink href=#investigating-the-pki-setup-on-the-control-plane-node title="Permanent link">&para;</a></h2> <p>The core pki directory, contains the certs and keys for all core functions in your cluster, the self signed CA, server certificate and key for encryption by API Server, etcd's cert setup, sa (serviceaccount) and more.</p> <p><code>ls -l /etc/kubernetes/pki</code></p> <p>Read the ca.crt to view the certificates information, useful to determine the validity date of the certificate You can use this command to read the information about any of the *.crt in this folder Be sure to check out the validity and the Subject CN</p> <p><code>openssl x509 -in /etc/kubernetes/pki/ca.crt -text -noout | more</code></p> <p>2 - kubeconfig file location, for system components, controller manager, kubelet and scheduler.</p> <p><code>ls /etc/kubernetes</code></p> <p>certificate-authority-data is a base64 encoded ca.cert You can also see the server for the API Server is https And there is also a client-certificate-data which is the client certificate used. And client-key-data is the private key for the client cert. these are used to authenticate the client to the api server</p> <p><code>sudo more /etc/kubernetes/scheduler.conf</code></p> <blockquote> <p>The kube-proxy has it's kube-config as a configmap rather than a file on the file system.</p> </blockquote> <p><code>kubectl get configmap -n kube-system kube-proxy -o yaml</code></p> <h2 id=kubernetes-create-new-user-certificate>Kubernetes - Create New User Certificate<a class=headerlink href=#kubernetes-create-new-user-certificate title="Permanent link">&para;</a></h2> <ul> <li>References: https://geekflare.com/openssl-commands-certificates/ https://kubernetes.io/docs/concepts/cluster-administration/certificates/#cfssl https://www.freecodecamp.org/news/openssl-command-cheatsheet-b441be1e8c4a/ https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs</li> </ul> <h3 id=1-create-a-rsa-private-key>1 - Create a RSA private key<a class=headerlink href=#1-create-a-rsa-private-key title="Permanent link">&para;</a></h3> <p><code>openssl genrsa -out demouser.key 2048</code></p> <pre><code class=language-bash>$ cat demouser.key
-----BEGIN RSA PRIVATE KEY-----
MIIEpAIBAAKCAQEAww0cP9PFhgXLSEMRTmvTKym2zcyMa9P5CgqGU9+MCv/Ngiw4
RjcuqsKyqIhetgzNVDHtlFA4zELuHbzgAv1uvky8DbINaf6aIgUnf2ZragpC8IQn
lfHUIKapXdjqwbK3JQCY5W7ba0c3fdvOBHXkOij74tLDxtx/jP7x08zVE5UIiqeC
XwOkiP1mjHHWsU8UkTKNnwjUFSoW/BUVQDJeK9WPtkd547djyOiFOgogkfXOy5F2
HH1n23qOFT8DaNL9KRfMgnQEIXVhBJclRHgGXun6ynFKE3WMZGKDpUq4wFaKvU2X
mvEPIPR3Iu+pt0hJjSGpnlJWHfr6MQn7y4HO4QIDAQABAoIBAHtaxD3diXL8IRa/
S6ej63XFuNWogjoDYeGmzFMo8qFWK7siiihl576YyXJqZDOQHx8bQFxm67TKs1rd
Q3LAopP5ZYjnzTH2kbXoOpWIyW/Ts4f2nC5pNTW9ESnH8Je1lbvyB8A5/sx2yrJv
G3iYslDR8JL/pk8Szhv2dCv1w9/Qa2SlF2YCqy41V4Lih2n76cAZ7csC7PjynBVH
h+m3Tz98gug6oEWfIMPpyTPLwCO2+P6f9hxtlFa8zWbXJ3MYiIn0DwMA0UEf40S4
qyEAU4c6jcFWdIEIRNTmJr2WwAfopP1v78plSMuqIo2rNns0o/ZvVkVer9AhEwR3
EjaAMVECgYEA4CpHHI1rjxLVI1LeOTCasOCI4csBeCSspJyqSppYAKy9F81iKBeV
o9UfjvunZ6x8ZzZWzEFBv8YByTSKCd3Uuq/P33LQNgZjH2X4EZhP4a948CV+V0li
+0h4kHLR7Te5ZuFePZ7ptoUf99Ao/N3JUATC2oD6VSaOQoJo3w0zat0CgYEA3sBe
pLB4AGgKZPwOzHwVInJsbNC4R9w1ckZLFHZifZ89agbEvcGJW/jVgw8/E+SPNa3E
100WaDwa88864YCROIuF2KWtAa/D16nAf8hsk4uGO8RnqvpFB7qYlp5GSRSgTAMv
/nbcjcCObEOAvK8ICBi4j/+GCVyRDBG2lYEGqdUCgYAfWgpkFetrMUkaDacC/KdG
AcFjQw9LjGWRCFBQ6tFQFtjDkXge/11wcohdaRj6yQcFMHZnTuExPzJUv8Jmqt3r
1lcOe3Jfe/k1FP/jBhh2CiKyA6xt7NepKXOjUEvID7kgiHizyZwKaQgVksmIxEQ5
qtDN2qgobKIM70xXlfMRCQKBgQCf9tYAvxnucMjGLJ0UDCfBTRrAKkOsl19qaUCR
uVKRlEGuWp3/B3V1LwVl0RUjXAfcLKYnV5y3zjIs1K0cNBAV41yDcLcFdwvVXHp5
SZ1vd8s2MJ2iE4hvPHlH8PHYmY9kBwX4X7OTuKyO4wsYdTn3Vol0H7RKFMe1OyM7
yiTW4QKBgQDeR4OfE4p61bJY+0rArEEtvXqReYzZAxqlGE0m6FL2zXNQ4MSqecgf
1lnzCUPcHfH2b0DsPAVDsJIaOmqLFVv7BXeG3J0OjGAwAIvDFHqMtp/36CYwWCN1
TahZVjHWx2+SqwxelhSZJHlRnGLqwfo8hqeb0CNnaiLcldX5WVnovw==
-----END RSA PRIVATE KEY-----
</code></pre> <blockquote> <p>Verify private key file using openssl</p> </blockquote> <p><code>openssl rsa -in demouser.key -check</code></p> <blockquote> <p>Print public key using openssl</p> </blockquote> <p><code>openssl rsa -in demouser.key -pubout</code></p> <h3 id=2-generate-a-csr>2 - Generate a CSR<a class=headerlink href=#2-generate-a-csr title="Permanent link">&para;</a></h3> <p>CN (Common Name) is your username, O (Organization) is the Group</p> <blockquote> <p>If you get an error Can't load /home/USERNAME/.rnd into RNG - comment out RANDFILE from /etc/ssl/openssl.conf see this link for more details https://github.com/openssl/openssl/issues/7754#issuecomment-541307674</p> </blockquote> <p><code>openssl req -new -key demouser.key -out demouser.csr -subj "/CN=demouser"</code></p> <p>or you can leave subject out and be prompted for additional information</p> <pre><code class=language-bash>$ openssl req -new -key demouser.key -out demouser.csr
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name: 2-digit country code where your organization is legally located.
State/Province: Write the full name of the state where your organization is legally located.
City: Write the full name of the city where your organization is legally located.
Organization Name: Write the legal name of your organization.
Organization Unit: Name of the department (Not Compulsory. Press Enter to skip)
Common Name: Your Fully Qualified Domain Name (e.g., www.yourdomainname.com.)
Email: The email ID through which certification will take place (Not Compulsory. Press Enter to skip)
</code></pre> <p>The certificate request we'll use in the CertificateSigningRequest</p> <pre><code class=language-bash>$ cat demouser.csr
-----BEGIN CERTIFICATE REQUEST-----
MIICWDCCAUACAQAwEzERMA8GA1UEAwwIZGVtb3VzZXIwggEiMA0GCSqGSIb3DQEB
AQUAA4IBDwAwggEKAoIBAQDDDRw/08WGBctIQxFOa9MrKbbNzIxr0/kKCoZT34wK
/82CLDhGNy6qwrKoiF62DM1UMe2UUDjMQu4dvOAC/W6+TLwNsg1p/poiBSd/Zmtq
CkLwhCeV8dQgpqld2OrBsrclAJjlbttrRzd9284EdeQ6KPvi0sPG3H+M/vHTzNUT
lQiKp4JfA6SI/WaMcdaxTxSRMo2fCNQVKhb8FRVAMl4r1Y+2R3njt2PI6IU6CiCR
9c7LkXYcfWfbeo4VPwNo0v0pF8yCdAQhdWEElyVEeAZe6frKcUoTdYxkYoOlSrjA
Voq9TZea8Q8g9Hci76m3SEmNIameUlYd+voxCfvLgc7hAgMBAAGgADANBgkqhkiG
9w0BAQsFAAOCAQEARM18RbWm3225P61t9djzU21J0ftqSG2FPtYIL6hFSJFcwknq
kG/DlUDiqAFBmDyS+iJCcEabouzbHewdrNEI+CstJu1n66FITCdkUmFdFnqnQBRB
6tvBSv0h/z0GioIRuLzgO1iWegl26a3TNt8I1S8YbJtTRnuV8GuVdKhm9BOYkMDZ
dsS9uJ61zYN77HKVpiehyC94COzSMKGiipOzdu61BRDww/0X2rg1OVpy0z53ofUO
HayIUOw7iYw2bueZpFpaP0vJ09lpwAu3KW5wUxT5Ng024oOfW6kT2dNa3epstqYQ
IKy0TLJhJDqWkS942k6g82jYqz4+o0NruQ1HKw==
-----END CERTIFICATE REQUEST-----
</code></pre> <blockquote> <p>Verify CSR file</p> </blockquote> <pre><code class=language-bash>$ openssl req -in demouser.csr -noout -text -verify
verify OK
Certificate Request:
    Data:
        Version: 1 (0x0)
        Subject: C = US, ST = DE, L = Middletown, O = Home, OU = Lab, CN = demouser, emailAddress = no-reply@demo.user
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (2048 bit)
</code></pre> <blockquote> <p>The CertificateSigningRequest needs to be base64 encoded and also have the header and trailer pulled out.</p> </blockquote> <p><code>cat demouser.csr | base64 | tr -d "\n" &gt; demouser.base64.csr</code></p> <p>to decode:</p> <p><code>cat demouser.base64.csr | base64 -d</code></p> <blockquote> <p>ALTERNATIVE - Encode with Openssl Base64</p> </blockquote> <p><code>cat demouser.csr | openssl enc -base64 -A &gt; demouser.base64.csr</code></p> <p>to decode:</p> <p><code>cat demouser.base64.csr | openssl base64 -A -d</code></p> <h3 id=1b2b-alternative-create-a-new-private-key-and-certificate-signing-request>1B/2B - ALTERNATIVE - Create a new private key AND Certificate Signing Request<a class=headerlink href=#1b2b-alternative-create-a-new-private-key-and-certificate-signing-request title="Permanent link">&para;</a></h3> <p>The below command will generate CSR and a 2048-bit RSA key file. If you intend to use this certificate in Apache or Nginx, then you need to send this CSR file to certificate issuer authority, and they will give you a signed certificate mostly in der or pem format which you need to configure in Apache or Nginx web server.</p> <p><code>openssl req -out demouser.csr -newkey rsa:2048 -nodes -keyout demouser.key</code></p> <h3 id=3-submit-the-certificatesigningrequest-to-the-api-server-k8s-119>3 - Submit the CertificateSigningRequest to the API Server - K8s 1.19+<a class=headerlink href=#3-submit-the-certificatesigningrequest-to-the-api-server-k8s-119 title="Permanent link">&para;</a></h3> <blockquote> <p>UPDATE: If you're on 1.19+ use this CertificateSigningRequest</p> </blockquote> <p>Key elements, name, request and usages (must be client auth)</p> <pre><code class=language-bash>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: demouser
spec:
  groups:
  - system:authenticated
  request: $(cat demouser.base64.csr)
  signerName: kubernetes.io/kube-apiserver-client
  usages:
  - client auth
EOF
</code></pre> <h3 id=3-submit-the-certificatesigningrequest-to-the-api-server-k8s-118>3 - Submit the CertificateSigningRequest to the API Server - K8s 1.18<a class=headerlink href=#3-submit-the-certificatesigningrequest-to-the-api-server-k8s-118 title="Permanent link">&para;</a></h3> <blockquote> <p>UPDATE: If you're on 1.18.x or below use this CertificateSigningRequest</p> </blockquote> <p>Key elements, name, request and usages (must be client auth)</p> <pre><code class=language-bash>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: certificates.k8s.io/v1beta1
kind: CertificateSigningRequest
metadata:
  name: demouser
spec:
  groups:
  - system:authenticated
  request: $(cat demouser.base64.csr)
  usages:
  - client auth
EOF
</code></pre> <p>Let's get the CSR to see it's current state. The CSR will delete after an hour This should currently be Pending, awaiting administrative approval</p> <pre><code class=language-bash>$ kubectl get certificatesigningrequests
NAME       AGE   SIGNERNAME                            REQUESTOR   CONDITION
demouser   25s   kubernetes.io/kube-apiserver-client   k8s-admin   Pending
</code></pre> <h3 id=4-approve-the-csr>4 - Approve the CSR<a class=headerlink href=#4-approve-the-csr title="Permanent link">&para;</a></h3> <p><code>kubectl certificate approve demouser</code></p> <p>If we get the state now, you'll see Approved, Issued. The CSR is updated with the certificate in .status.certificate</p> <pre><code class=language-bash>$ kubectl get certificatesigningrequests demouser
NAME       AGE   SIGNERNAME                            REQUESTOR   CONDITION
demouser   93s   kubernetes.io/kube-apiserver-client   k8s-admin   Approved,Issued
</code></pre> <h3 id=5-retrieve-the-certificate-from-the-csr-object-its-base64-encoded>5 - Retrieve the certificate from the CSR object, it's base64 encoded<a class=headerlink href=#5-retrieve-the-certificate-from-the-csr-object-its-base64-encoded title="Permanent link">&para;</a></h3> <pre><code class=language-bash>kubectl get certificatesigningrequests demouser \
  -o jsonpath='{ .status.certificate }'  | base64 --decode
</code></pre> <p>Let's go ahead and save the certificate into a local file. We're going to use this file to build a kubeconfig file to authenticate to the API Server with</p> <pre><code class=language-bash>kubectl get certificatesigningrequests demouser -o jsonpath='{ .status.certificate }'  | base64 --decode &gt; calmuser.crt
</code></pre> <p>Check the contents of the file</p> <p><code>cat demouser.crt</code></p> <p>Read the certficate itself Key elements: Issuer is our CA, Validity one year, Subject CN=demousers</p> <p><code>openssl x509 -in demouser.crt -text -noout | head -n 15</code></p> <p>Now that we have the certificate we can use that to build a kubeconfig file with to log into this cluster. We'll use demouser.key and demouser.crt</p> <p><code>ls demouser.*</code></p> <h3 id=complete-alternative-a-create-a-self-signed-certificate>COMPLETE ALTERNATIVE A - Create a Self-signed Certificate<a class=headerlink href=#complete-alternative-a-create-a-self-signed-certificate title="Permanent link">&para;</a></h3> <p>The below command will generate a self-signed certificate valid for two years with sha256 –days parameter to extend the validity.</p> <p>Ex: to have self-signed valid for two years.</p> <p><code>openssl req -x509 -sha256 -nodes -days 730 -newkey rsa:2048 -keyout demouser_self.key -out demouser_cert.pem</code></p> <h3 id=misc-alternative-b>MISC ALTERNATIVE B<a class=headerlink href=#misc-alternative-b title="Permanent link">&para;</a></h3> <h4 id=create-a-csr-from-existing-certificate-and-private-key>Create a CSR from existing certificate and private key<a class=headerlink href=#create-a-csr-from-existing-certificate-and-private-key title="Permanent link">&para;</a></h4> <p><code>openssl x509 -x509toreq -in cert.pem -out example.csr -signkey example.key</code></p> <p>or just from existing private key</p> <p><code>openssl req –out certificate.csr –key existing.key –new</code></p> <h4 id=generate-a-csr-for-multi-domain-san-certificate-by-supplying-an-openssl-config-file>Generate a CSR for multi-domain SAN certificate by supplying an openssl config file:<a class=headerlink href=#generate-a-csr-for-multi-domain-san-certificate-by-supplying-an-openssl-config-file title="Permanent link">&para;</a></h4> <p><code>openssl req -new -key example.key -out example.csr -config req.conf</code></p> <pre><code class=language-bash>cat &lt;&lt;EOF | tee req.conf
[req]prompt=nodefault_md = sha256distinguished_name = dnreq_extensions = req_ext
[dn]CN=example.com
[req_ext]subjectAltName=@alt_names
[alt_names]DNS.1=example.comDNS.2=www.example.comDNS.3=ftp.example.com
EOF
</code></pre> <h4 id=create-x509-certificates>Create X.509 certificates<a class=headerlink href=#create-x509-certificates title="Permanent link">&para;</a></h4> <p>Create self-signed certificate and new private key from scratch:</p> <p><code>openssl req -nodes -newkey rsa:2048 -keyout example.key -out example.crt -x509 -days 365</code></p> <p>Create a self signed certificate using existing CSR and private key:</p> <p><code>openssl x509 -req -in example.csr -signkey example.key -out example.crt -days 365</code></p> <h3 id=troubleshooting-certificate-issues>Troubleshooting Certificate Issues<a class=headerlink href=#troubleshooting-certificate-issues title="Permanent link">&para;</a></h3> <blockquote> <p>Verify that private key matches a certificate, CSR and Private Key</p> </blockquote> <p><code>openssl verify demouser.crt</code></p> <p><code>openssl rsa -in demouser.key –check</code></p> <p><code>openssl rsa -noout -modulus -in demouser.key | openssl sha256</code></p> <p><code>openssl x509 -noout -modulus -in demouser.crt | openssl sha256</code></p> <p><code>openssl req -noout -modulus -in demouser.csr | openssl sha256</code></p> <blockquote> <p>Verify a Certificate was Signed by a CA</p> </blockquote> <p><code>openssl verify -verbose -CAFile ca.crt domain.crt</code></p> <blockquote> <p>Verifty the Certificate Signer Authority</p> </blockquote> <p><code>openssl x509 -in certfile.pem -text –noout</code></p> <p><code>openssl x509 -in demouser_cert.pem -noout -issuer -issuer_hash</code></p> <ul> <li>Check Hash Value of A Certificate</li> </ul> <p><code>openssl x509 -noout -hash -in demouser_cert.pem</code></p> <blockquote> <p>Verify certificate, when you have <em>intermediate certificate chain</em>. <em>Root certificate is not a part of bundle</em>, and should be configured as a trusted on your machine.</p> </blockquote> <p><code>openssl verify -untrusted demouser-intermediate.pem demouser.crt</code></p> <blockquote> <p>Verify certificate, when you have <em>intermediate certificate chain</em> and <em>root certificate</em>, that is not configured as a trusted one.</p> </blockquote> <p><code>openssl verify -CAFile root.crt -untrusted intermediate-ca-chain.pem child-demouser.crt</code></p> <blockquote> <p>Verify that certificate served by a remote server covers given host name. Useful to check your mutlidomain certificate properly covers all the host names.</p> </blockquote> <p><code>openssl s_client -verify_hostname www.example.com -connect example.com:443</code></p> <blockquote> <p>TLS client to connect to a remote server</p> </blockquote> <p>Test SSL certificate of particular URL</p> <ul> <li>Connect to a server supporting TLS:</li> </ul> <p><code>openssl s_client -connect example.com:443</code> <code>openssl s_client -host example.com -port 443</code> <code>openssl s_client -connect yoururl.com:443 –showcerts</code></p> <ul> <li>Connect to a server and show full certificate chain:</li> </ul> <p><code>openssl s_client -showcerts -host example.com -port 443 &lt;/dev/null</code></p> <ul> <li>Extract the certificate:</li> </ul> <p><code>openssl s_client -connect example.com:443 2&gt;&amp;1 &lt; /dev/null | sed -n '/-----BEGIN/,/-----END/p' &gt; certificate.pem</code></p> <ul> <li>Override SNI (Server Name Indication) extension with another server name. Useful for testing when multiple secure sites are hosted on same IP address:</li> </ul> <p><code>openssl s_client -servername www.example.com -host example.com -port 443</code></p> <ul> <li>Measure SSL connection time without/with session reuse:</li> </ul> <p><code>openssl s_time -connect example.com:443 -new</code></p> <p><code>openssl s_time -connect example.com:443 -reuse</code></p> <blockquote> <p>Convert between encoding and container formats</p> </blockquote> <ul> <li>Convert certificate between DER and PEM formats:</li> </ul> <p><code>openssl x509 -in example.pem -outform der -out example.der</code> <code>openssl x509 -in example.der -inform der -out example.pem</code></p> <blockquote> <p>Check PEM File Certificate Expiration Date</p> </blockquote> <p><code>openssl x509 -noout -in certificate.pem -dates</code></p> <blockquote> <p>Check Certificate Expiration Date of SSL URL</p> </blockquote> <p><code>openssl s_client -connect google.com:443 2&gt;/dev/null | openssl x509 -noout -enddate</code></p> <blockquote> <p>Check TLS Versions are accepted on URL</p> </blockquote> <p><code>openssl s_client -connect secureurl.com:443 –tls1</code></p> <p><code>openssl s_client -connect secureurl.com:443 –tls1_1</code></p> <p>openssl s_client -showcerts -servername rancher.10.38.20.81.nip.io -connect rancher.10.38.20.81.nip.io:443</p> <h2 id=capacity-planning>Capacity Planning<a class=headerlink href=#capacity-planning title="Permanent link">&para;</a></h2> <blockquote> <p>Get vCPU Count from all nodes</p> </blockquote> <p>kubectl get nodes -o=jsonpath="{range .items[*]}{.metadata.name}{\"\t\"} \ {.status.capacity.cpu}{\"\n\"}{end}"</p> </article> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../../architecture-tldr/kubernetes-best-practices/references/ class="md-footer__link md-footer__link--prev" aria-label="Previous: kubernetes best practices" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> kubernetes best practices </div> </div> </a> <a href=../etcd/ class="md-footer__link md-footer__link--next" aria-label="Next: etcd" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> etcd </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2022 Jesse Gonzalez </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["content.code.annotate", "content.tabs.link", "navigation.indexes", "navigation.instant", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.85cb4492.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../../../assets/javascripts/bundle.a877e258.min.js></script> </body> </html>